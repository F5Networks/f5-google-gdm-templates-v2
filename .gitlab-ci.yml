image: ${ARTIFACTORY_SERVER}/dockerhub-remote/python:3.7-alpine

services:
  - ${ARTIFACTORY_SERVER}/dockerhub-remote/docker:dind

stages:
  - linters
  - smoke-tests
  - release_test_prep
  - sprinkle-tests
  - droplets
  - release
  - post-release-tests
  - admin

variables:
  GIT_SUBMODULE_STRATEGY: recursive

# lint python and yaml files with linters
run_gdm_linters:
  stage: linters
  tags:
    - docker-executor
  except:
    refs:
      - schedules
      - triggers
      - pipelines
  script:
    - apk add --no-cache build-base
    - apk add --no-cache bash
    - make gdm_lint

# validate README file(s) only contain links that respond with 200 OK
# this pre-release job only checks internal links to avoid failures
# when tag version is unpublished
run_link_checker:
  image: ${ARTIFACTORY_SERVER}/dockerhub-remote/node:10
  stage: smoke-tests
  tags:
    - docker-executor
  only:
    refs:
      # run only on release branch and develop
      - /^R.*/
      - develop
  except:
    refs:
      - schedules
      - triggers
      - pipelines
    variables:
      - $RELEASE_RUNTIME_INIT_TESTS == "true"
  script:
    - make link_check
  allow_failure: true

# validate test policy parameters are present
run_test_param_checker:
  image: ${ARTIFACTORY_SERVER}/dockerhub-remote/python:3.7
  stage: smoke-tests
  tags:
    - docker-executor
  except:
    refs:
      - schedules
      - triggers
      - pipelines
    variables:
      - $RELEASE_RUNTIME_INIT_TESTS == "true"
  script:
    - make test_policy_check

# validate parameters match style guide
verify_parameters_match_style_guide:
  stage: smoke-tests
  tags:
    - docker-executor
  except:
    refs:
      - schedules
      - triggers
      - pipelines
  script:
    - apk add --no-cache build-base
    - apk add --no-cache bash
    - make run_compare_parameters
    - make run_expected_diff
  artifacts:
      paths:
          - cloud-tools/parameter-parser/parameters_diff.yaml
          - cloud-tools/parameter-parser/parameters_config.yaml
      when: always
      expire_in: 1 week

# validate outputs match style guide
verify_outputs_match_style_guide:
  stage: smoke-tests
  tags:
    - docker-executor
  except:
    refs:
      - schedules
      - triggers
      - pipelines
  script:
    - apk add --no-cache build-base
    - apk add --no-cache bash
    - make run_compare_outputs
    - make run_expected_outputs_diff
  artifacts:
    paths:
      - cloud-tools/parameter-parser/outputs_diff.yaml
      - cloud-tools/parameter-parser/outputs_config.yaml
    when: always
    expire_in: 1 week

# GDM Template Modules Tests

# This job passes in the test plan to the sprinkler.py script that parses the plan and triggers the dewdrop_test_run
# This job is to be scheduled once the plan has been solidified
# Environment variables:
#   TEST_POLICY: path to test plan, this gets set under the scheduling in gitlab
#   STACK_TYPE: index for elastic search logging, this is set under the scheduling in gitlab
#   DAILY_TEST_TOKEN: token used to trigger git pipeline from the sprinkler script
#   CI_COMMIT_REF_NAME: branch name


# Module: GDM Network Template
gdm_network_module_test_job:
  stage: sprinkle-tests
  when: manual
  tags:
    - docker-executor
  only:
    refs:
      - branches
    changes:
      - automated-test-scripts/data/f5-google-gdm-templates-v2/examples/modules/network/**/*
      - automated-test-scripts/f5-google-gdm-templates-v2/examples/modules/network/**/*
      - examples/modules/network/network.py
  except:
    refs:
      - schedules
      - triggers
      - pipelines
    variables:
      - $RELEASE_RUNTIME_INIT_TESTS == "true"
      - $CI_COMMIT_MESSAGE =~ /smart:init/
  variables:
    TEST_POLICY: automated-test-scripts/data/f5-google-gdm-templates-v2/examples/modules/network/test_policy.yaml
    STACK_TYPE: dewdrop-preproduction
  script:
    - pip install -r cloud-tools/master-job/requirements.txt
    - cloud-tools/master-job/sprinkler.py --test-plan $TEST_POLICY --token $CI_JOB_TOKEN --branch $CI_COMMIT_REF_NAME --stack-type $STACK_TYPE --project-id $CI_PROJECT_ID
  retry:
    max: 2
    when:
      - runner_system_failure
      - stuck_or_timeout_failure

# Module: GDM Application Template
gdm_application_module_test_job:
  stage: sprinkle-tests
  when: manual
  tags:
    - docker-executor
  only:
    refs:
      - branches
    changes:
      - automated-test-scripts/data/f5-google-gdm-templates-v2/examples/modules/application/**/*
      - automated-test-scripts/f5-google-gdm-templates-v2/examples/modules/application/**/*
      - examples/modules/application/application.py
  except:
    refs:
      - schedules
      - triggers
      - pipelines
    variables:
      - $RELEASE_RUNTIME_INIT_TESTS == "true"
      - $CI_COMMIT_MESSAGE =~ /smart:init/
  variables:
    TEST_POLICY: automated-test-scripts/data/f5-google-gdm-templates-v2/examples/modules/application/test_policy.yaml
    STACK_TYPE: dewdrop-preproduction
  script:
    - pip install -r cloud-tools/master-job/requirements.txt
    - cloud-tools/master-job/sprinkler.py --test-plan $TEST_POLICY --token $CI_JOB_TOKEN --branch $CI_COMMIT_REF_NAME --stack-type $STACK_TYPE --project-id $CI_PROJECT_ID
  retry:
    max: 2
    when:
      - runner_system_failure
      - stuck_or_timeout_failure

# Module: GDM Bastion Template
gdm_bastion_module_test_job:
  stage: sprinkle-tests
  when: manual
  tags:
    - docker-executor
  only:
    refs:
      - branches
    changes:
      - automated-test-scripts/data/f5-google-gdm-templates-v2/examples/modules/bastion/**/*
      - automated-test-scripts/f5-google-gdm-templates-v2/examples/modules/bastion/**/*
      - examples/modules/bastion/bastion.py
  except:
    refs:
      - schedules
      - triggers
      - pipelines
    variables:
      - $RELEASE_RUNTIME_INIT_TESTS == "true"
      - $CI_COMMIT_MESSAGE =~ /smart:init/
  variables:
    TEST_POLICY: automated-test-scripts/data/f5-google-gdm-templates-v2/examples/modules/bastion/test_policy.yaml
    STACK_TYPE: dewdrop-preproduction
  script:
    - pip install -r cloud-tools/master-job/requirements.txt
    - cloud-tools/master-job/sprinkler.py --test-plan $TEST_POLICY --token $CI_JOB_TOKEN --branch $CI_COMMIT_REF_NAME --stack-type $STACK_TYPE --project-id $CI_PROJECT_ID
  retry:
    max: 2
    when:
      - runner_system_failure
      - stuck_or_timeout_failure

# Module: GDM BIGIP Autoscale Template
gdm_bigip_autoscale_module_test_job:
  stage: sprinkle-tests
  when: manual
  tags:
    - docker-executor
  only:
    refs:
      - branches
    changes:
      - automated-test-scripts/data/f5-google-gdm-templates-v2/examples/modules/bigip-autoscale/**/*
      - automated-test-scripts/f5-google-gdm-templates-v2/examples/modules/bigip-autoscale/**/*
      - examples/modules/bigip-autoscale/bigip_autoscale.py
  except:
    refs:
      - schedules
      - triggers
      - pipelines
    variables:
      - $RELEASE_RUNTIME_INIT_TESTS == "true"
      - $CI_COMMIT_MESSAGE =~ /smart:init/
  variables:
    TEST_POLICY: automated-test-scripts/data/f5-google-gdm-templates-v2/examples/modules/bigip-autoscale/test_policy.yaml
    STACK_TYPE: dewdrop-preproduction
  script:
    - pip install -r cloud-tools/master-job/requirements.txt
    - cloud-tools/master-job/sprinkler.py --test-plan $TEST_POLICY --token $CI_JOB_TOKEN --branch $CI_COMMIT_REF_NAME --stack-type $STACK_TYPE --project-id $CI_PROJECT_ID
  retry:
    max: 2
    when:
      - runner_system_failure
      - stuck_or_timeout_failure

# Module: GDM BIGIP standalone Template
gdm_bigip_standalone_module_test_job:
  stage: sprinkle-tests
  when: manual
  tags:
    - docker-executor
  only:
    refs:
      - branches
    changes:
      - automated-test-scripts/data/f5-google-gdm-templates-v2/examples/modules/bigip-standalone/**/*
      - automated-test-scripts/f5-google-gdm-templates-v2/examples/modules/bigip-standalone/**/*
      - examples/modules/bigip-standalone/bigip_standalone.py
  except:
    refs:
      - schedules
      - triggers
      - pipelines
    variables:
      - $RELEASE_RUNTIME_INIT_TESTS == "true"
      - $CI_COMMIT_MESSAGE =~ /smart:init/
  variables:
    TEST_POLICY: automated-test-scripts/data/f5-google-gdm-templates-v2/examples/modules/bigip-standalone/test_policy.yaml
    STACK_TYPE: dewdrop-preproduction
  script:
    - pip install -r cloud-tools/master-job/requirements.txt
    - cloud-tools/master-job/sprinkler.py --test-plan $TEST_POLICY --token $CI_JOB_TOKEN --branch $CI_COMMIT_REF_NAME --stack-type $STACK_TYPE --project-id $CI_PROJECT_ID
  retry:
    max: 2
    when:
      - runner_system_failure
      - stuck_or_timeout_failure

# Module: GDM DAG Template
gdm_dag_module_test_job:
  stage: sprinkle-tests
  when: manual
  tags:
    - docker-executor
  only:
    refs:
      - branches
    changes:
      - automated-test-scripts/data/f5-google-gdm-templates-v2/examples/modules/dag/**/*
      - automated-test-scripts/f5-google-gdm-templates-v2/examples/modules/dag/**/*
      - examples/modules/dag/dag.py
  except:
    refs:
      - schedules
      - triggers
      - pipelines
    variables:
      - $RELEASE_RUNTIME_INIT_TESTS == "true"
      - $CI_COMMIT_MESSAGE =~ /smart:init/
  variables:
    TEST_POLICY: automated-test-scripts/data/f5-google-gdm-templates-v2/examples/modules/dag/test_policy.yaml
    STACK_TYPE: dewdrop-preproduction
  script:
    - pip install -r cloud-tools/master-job/requirements.txt
    - cloud-tools/master-job/sprinkler.py --test-plan $TEST_POLICY --token $CI_JOB_TOKEN --branch $CI_COMMIT_REF_NAME --stack-type $STACK_TYPE --project-id $CI_PROJECT_ID
  retry:
    max: 2
    when:
      - runner_system_failure
      - stuck_or_timeout_failure

# Module: GDM Function Template
gdm_function_module_test_job:
  stage: sprinkle-tests
  when: manual
  tags:
    - docker-executor
  only:
    refs:
      - branches
    changes:
      - automated-test-scripts/data/f5-google-gdm-templates-v2/examples/modules/function/**/*
      - automated-test-scripts/f5-google-gdm-templates-v2/examples/modules/function/**/*
      - examples/modules/function/function.py
  except:
    refs:
      - schedules
      - triggers
      - pipelines
    variables:
      - $RELEASE_RUNTIME_INIT_TESTS == "true"
      - $CI_COMMIT_MESSAGE =~ /smart:init/
  variables:
    TEST_POLICY: automated-test-scripts/data/f5-google-gdm-templates-v2/examples/modules/function/test_policy.yaml
    STACK_TYPE: dewdrop-preproduction
  script:
    - pip install -r cloud-tools/master-job/requirements.txt
    - cloud-tools/master-job/sprinkler.py --test-plan $TEST_POLICY --token $CI_JOB_TOKEN --branch $CI_COMMIT_REF_NAME --stack-type $STACK_TYPE --project-id $CI_PROJECT_ID
  retry:
    max: 2
    when:
      - runner_system_failure
      - stuck_or_timeout_failure

# Module: GDM Autoscale BIGIQ Template
gdm_autoscale_bigiq_example_test_job:
  stage: sprinkle-tests
  when: manual
  tags:
    - docker-executor
  only:
    refs:
      - branches
    changes:
      - automated-test-scripts/data/f5-google-gdm-templates-v2/examples/autoscale/payg/**/*
      - automated-test-scripts/f5-google-gdm-templates-v2/examples/autoscale/payg/**/*
      - examples/autoscale/payg/autoscale.py
      - examples/modules/access/access.py
      - examples/modules/application/application.py
      - examples/modules/bastion/bastion.py
      - examples/modules/bigip-autoscale/bigip_autoscale.py
      - examples/modules/dag/dag.py
      - examples/modules/network/network.py
      - examples/autoscale/bigip-configurations/runtime-init-conf-payg.yaml
  except:
    refs:
      - schedules
      - triggers
      - pipelines
    variables:
      - $RELEASE_RUNTIME_INIT_TESTS == "true"
      - $CI_COMMIT_MESSAGE =~ /smart:init/
  variables:
    TEST_POLICY: automated-test-scripts/data/f5-google-gdm-templates-v2/examples/autoscale/bigiq/test_policy_full.yaml
    STACK_TYPE: dewdrop-preproduction
  script:
    - pip install -r cloud-tools/master-job/requirements.txt
    - cloud-tools/master-job/sprinkler.py --test-plan $TEST_POLICY --token $CI_JOB_TOKEN --branch $CI_COMMIT_REF_NAME --stack-type $STACK_TYPE --project-id $CI_PROJECT_ID
  retry:
    max: 2
    when:
      - runner_system_failure
      - stuck_or_timeout_failure

gdm_autoscale_bigiq_existing_test_job:
  stage: sprinkle-tests
  when: manual
  tags:
    - docker-executor
  only:
    refs:
      - branches
    changes:
      - automated-test-scripts/data/f5-google-gdm-templates-v2/examples/autoscale/bigiq/**/*
      - automated-test-scripts/f5-google-gdm-templates-v2/examples/autoscale/bigiq/**/*
      - examples/autoscale/bigiq/autoscale.py
      - examples/modules/access/access.py
      - examples/modules/application/application.py
      - examples/modules/bastion/bastion.py
      - examples/modules/bigip-autoscale/bigip_autoscale.py
      - examples/modules/dag/dag.py
      - examples/modules/function/function.py
      - examples/modules/network/network.py
      - examples/autoscale/bigip-configurations/runtime-init-conf-bigiq.yaml
  except:
    refs:
      - schedules
      - triggers
      - pipelines
    variables:
      - $RELEASE_RUNTIME_INIT_TESTS == "true"
      - $CI_COMMIT_MESSAGE =~ /smart:init/
  variables:
    TEST_POLICY: automated-test-scripts/data/f5-google-gdm-templates-v2/examples/autoscale/bigiq/test_policy_existing.yaml
    STACK_TYPE: dewdrop-preproduction
  script:
    - pip install -r cloud-tools/master-job/requirements.txt
    - cloud-tools/master-job/sprinkler.py --test-plan $TEST_POLICY --token $CI_JOB_TOKEN --branch $CI_COMMIT_REF_NAME --stack-type $STACK_TYPE --project-id $CI_PROJECT_ID
  retry:
    max: 2
    when:
      - runner_system_failure
      - stuck_or_timeout_failure

# Module: GDM Autoscale PAYG Template
gdm_autoscale_payg_example_test_job:
  stage: sprinkle-tests
  when: manual
  tags:
    - docker-executor
  only:
    refs:
      - branches
    changes:
      - automated-test-scripts/data/f5-google-gdm-templates-v2/examples/autoscale/payg_existing_network/**/*
      - automated-test-scripts/f5-google-gdm-templates-v2/examples/autoscale/payg_existing_network/**/*
      - examples/autoscale/payg/autoscale-existing-network.py
      - examples/autoscale/payg/autoscale-existing-network.py.schema
      - examples/autoscale/bigip-configurations/runtime-init-conf-payg.yaml
  except:
    refs:
      - schedules
      - triggers
      - pipelines
    variables:
      - $RELEASE_RUNTIME_INIT_TESTS == "true"
      - $CI_COMMIT_MESSAGE =~ /smart:init/
  variables:
    TEST_POLICY: automated-test-scripts/data/f5-google-gdm-templates-v2/examples/autoscale/payg/test_policy_full.yaml
    STACK_TYPE: dewdrop-preproduction
  script:
    - pip install -r cloud-tools/master-job/requirements.txt
    - cloud-tools/master-job/sprinkler.py --test-plan $TEST_POLICY --token $CI_JOB_TOKEN --branch $CI_COMMIT_REF_NAME --stack-type $STACK_TYPE --project-id $CI_PROJECT_ID
  retry:
    max: 2
    when:
      - runner_system_failure
      - stuck_or_timeout_failure

gdm_autoscale_payg_existing_test_job:
  stage: sprinkle-tests
  when: manual
  tags:
    - docker-executor
  only:
    refs:
      - branches
    changes:
      - automated-test-scripts/data/f5-google-gdm-templates-v2/examples/autoscale/bigiq_existing_network/**/*
      - automated-test-scripts/f5-google-gdm-templates-v2/examples/autoscale/bigiq_existing_network/**/*
      - examples/autoscale/bigiq/autoscale-existing-network.py
      - examples/autoscale/bigiq/autoscale-existing-network.py.schema
      - examples/autoscale/bigip-configurations/runtime-init-conf-bigiq.yaml
  except:
    refs:
      - schedules
      - triggers
      - pipelines
    variables:
      - $RELEASE_RUNTIME_INIT_TESTS == "true"
      - $CI_COMMIT_MESSAGE =~ /smart:init/
  variables:
    TEST_POLICY: automated-test-scripts/data/f5-google-gdm-templates-v2/examples/autoscale/payg/test_policy_existing.yaml
    STACK_TYPE: dewdrop-preproduction
  script:
    - pip install -r cloud-tools/master-job/requirements.txt
    - cloud-tools/master-job/sprinkler.py --test-plan $TEST_POLICY --token $CI_JOB_TOKEN --branch $CI_COMMIT_REF_NAME --stack-type $STACK_TYPE --project-id $CI_PROJECT_ID
  retry:
    max: 2
    when:
      - runner_system_failure
      - stuck_or_timeout_failure

# Module: GDM Failover Template
gdm_failover_test_job:
  stage: sprinkle-tests
  when: manual
  tags:
    - docker-executor
  only:
    refs:
      - branches
    changes:
      - automated-test-scripts/data/f5-google-gdm-templates-v2/examples/failover/full/**/*
      - automated-test-scripts/f5-google-gdm-templates-v2/examples/failover/**/*
      - examples/failover/failover.py
      - examples/modules/access/access.py
      - examples/modules/application/application.py
      - examples/modules/bastion/bastion.py
      - examples/modules/bigip-standalone/bigip_standalone.py
      - examples/modules/dag/dag.py
      - examples/modules/network/network.py
      - examples/failover/bigip-configurations/*
  except:
    refs:
      - schedules
      - triggers
      - pipelines
    variables:
      - $RELEASE_RUNTIME_INIT_TESTS == "true"
      - $CI_COMMIT_MESSAGE =~ /smart:init/
  variables:
    TEST_POLICY: automated-test-scripts/data/f5-google-gdm-templates-v2/examples/failover/test_policy_full.yaml
    STACK_TYPE: dewdrop-preproduction
  script:
    - pip install -r cloud-tools/master-job/requirements.txt
    - cloud-tools/master-job/sprinkler.py --test-plan $TEST_POLICY --token $CI_JOB_TOKEN --branch $CI_COMMIT_REF_NAME --stack-type $STACK_TYPE --project-id $CI_PROJECT_ID
  retry:
    max: 2
    when:
      - runner_system_failure
      - stuck_or_timeout_failure

# Module: GDM Failover Existing Network Template
gdm_failover_existing_test_job:
  stage: sprinkle-tests
  when: manual
  tags:
    - docker-executor
  only:
    refs:
      - branches
    changes:
      - automated-test-scripts/data/f5-google-gdm-templates-v2/examples/failover/**/*
      - automated-test-scripts/f5-google-gdm-templates-v2/examples/failover/**/*
      - examples/failover/failover-existing-network.py
      - examples/modules/access/access.py
      - examples/modules/bigip-standalone/bigip_standalone.py
      - examples/modules/dag/dag.py
      - examples/failover/bigip-configurations/*
  except:
    refs:
      - schedules
      - triggers
      - pipelines
    variables:
      - $RELEASE_RUNTIME_INIT_TESTS == "true"
      - $CI_COMMIT_MESSAGE =~ /smart:init/
  variables:
    TEST_POLICY: automated-test-scripts/data/f5-google-gdm-templates-v2/examples/failover/test_policy_existing.yaml
    STACK_TYPE: dewdrop-preproduction
  script:
    - pip install -r cloud-tools/master-job/requirements.txt
    - cloud-tools/master-job/sprinkler.py --test-plan $TEST_POLICY --token $CI_JOB_TOKEN --branch $CI_COMMIT_REF_NAME --stack-type $STACK_TYPE --project-id $CI_PROJECT_ID
  retry:
    max: 2
    when:
      - runner_system_failure
      - stuck_or_timeout_failure

# Module: GDM Quickstart Template
gdm_quickstart_test_job:
  stage: sprinkle-tests
  when: manual
  tags:
    - docker-executor
  only:
    refs:
      - branches
    changes:
      - automated-test-scripts/data/f5-google-gdm-templates-v2/examples/quickstart/full/**/*
      - automated-test-scripts/f5-google-gdm-templates-v2/examples/quickstart/**/*
      - examples/quickstart/quickstart.py
      - examples/modules/application/application.py
      - examples/modules/bastion/bastion.py
      - examples/modules/bigip-standalone/bigip_standalone.py
      - examples/modules/dag/dag.py
      - examples/modules/network/network.py
      - examples/quickstart/bigip-configurations/*
  except:
    refs:
      - schedules
      - triggers
      - pipelines
    variables:
      - $RELEASE_RUNTIME_INIT_TESTS == "true"
      - $CI_COMMIT_MESSAGE =~ /smart:init/
  variables:
    TEST_POLICY: automated-test-scripts/data/f5-google-gdm-templates-v2/examples/quickstart/test_policy_full.yaml
    STACK_TYPE: dewdrop-preproduction
  script:
    - pip install -r cloud-tools/master-job/requirements.txt
    - cloud-tools/master-job/sprinkler.py --test-plan $TEST_POLICY --token $CI_JOB_TOKEN --branch $CI_COMMIT_REF_NAME --stack-type $STACK_TYPE --project-id $CI_PROJECT_ID
  retry:
    max: 2
    when:
      - runner_system_failure
      - stuck_or_timeout_failure

# Module: GDM Quickstart Existing Network Template
gdm_quickstart_existing_test_job:
  stage: sprinkle-tests
  when: manual
  tags:
    - docker-executor
  only:
    refs:
      - branches
    changes:
      - automated-test-scripts/data/f5-google-gdm-templates-v2/examples/quickstart/existing-network/**/*
      - automated-test-scripts/f5-google-gdm-templates-v2/examples/quickstart/**/*
      - examples/quickstart/quickstart-existing-network.py
      - examples/modules/bigip-standalone/bigip_standalone.py
      - examples/modules/dag/dag.py
      - examples/quickstart/bigip-configurations/*
  except:
    refs:
      - schedules
      - triggers
      - pipelines
    variables:
      - $RELEASE_RUNTIME_INIT_TESTS == "true"
      - $CI_COMMIT_MESSAGE =~ /smart:init/
  variables:
    TEST_POLICY: automated-test-scripts/data/f5-google-gdm-templates-v2/examples/quickstart/test_policy_existing.yaml
    STACK_TYPE: dewdrop-preproduction
  script:
    - pip install -r cloud-tools/master-job/requirements.txt
    - cloud-tools/master-job/sprinkler.py --test-plan $TEST_POLICY --token $CI_JOB_TOKEN --branch $CI_COMMIT_REF_NAME --stack-type $STACK_TYPE --project-id $CI_PROJECT_ID
  retry:
    max: 2
    when:
      - runner_system_failure
      - stuck_or_timeout_failure

pre_release_test_job:
  stage: sprinkle-tests
  tags:
    - docker-executor
  only:
    refs:
      - main
  except:
    variables:
      - $ANALYTICS_MESSAGE_PROCESS == "true"
      - $ANALYTICS_SCRIPTS_PROCESS == "true"
      - $VERIFY_REGKEY_COUNT == "true"
      - $REAPER_RUN == "true"
      - $DAILY_TESTS_MONITOR == "true"
      - $RELEASE_RUNTIME_INIT_TESTS == "true"
    refs:
      - schedules
      - triggers
      - pipelines
  variables:
    TEST_POLICY: automated-test-scripts/data/test_policies/pre_release_test.yaml
    STACK_TYPE: dewdrop-preproduction
  script:
    - pip install -r cloud-tools/master-job/requirements.txt
    - cloud-tools/master-job/sprinkler.py --test-plan $TEST_POLICY --token $CI_JOB_TOKEN --branch $CI_COMMIT_REF_NAME --stack-type $STACK_TYPE --project-id $CI_PROJECT_ID
  retry:
    max: 2
    when:
      - runner_system_failure
      - stuck_or_timeout_failure
# end of GDM Template Modules Tests

post_release_test_job:
  stage: sprinkle-tests
  tags:
    - docker-executor
  only:
    - schedules
  except:
    variables:
      - $ANALYTICS_MESSAGE_PROCESS == "true"
      - $ANALYTICS_SCRIPTS_PROCESS == "true"
      - $VERIFY_REGKEY_COUNT == "true"
      - $REAPER_RUN == "true"
      - $DAILY_TESTS_MONITOR == "true"
      - $RELEASE_RUNTIME_INIT_TESTS == "true"
      - $UPDATE_SCHEDULES == "true"
  variables:
    TEST_POLICY: cloud-tools/automated-test-scripts/data/test_policies/post_release_test.yaml
    STACK_TYPE: dewdrop-preproduction
  # Added a manual trigger for now so that this job doesn't get triggered after every commit
  when: manual
  script:
    - pip install -r cloud-tools/master-job/requirements.txt
    - cloud-tools/master-job/sprinkler.py --test-plan $TEST_POLICY --token $CI_JOB_TOKEN --branch $CI_COMMIT_REF_NAME --stack-type $STACK_TYPE --project-id $CI_PROJECT_ID
  retry:
    max: 2
    when:
      - runner_system_failure
      - stuck_or_timeout_failure

scheduled_test_job:
  stage: sprinkle-tests
  tags:
    - docker-executor
  only:
    - schedules
  except:
    variables:
      - $ANALYTICS_MESSAGE_PROCESS == "true"
      - $ANALYTICS_SCRIPTS_PROCESS == "true"
      - $VERIFY_REGKEY_COUNT == "true"
      - $REAPER_RUN == "true"
      - $DAILY_TESTS_MONITOR == "true"
      - $UPDATE_SCHEDULES == "true"
  variables:
    TEST_POLICY: set in schedule!
    STACK_TYPE: dewdrop-production
  script:
    - pip install -r cloud-tools/master-job/requirements.txt
    - cloud-tools/master-job/sprinkler.py --test-plan $TEST_POLICY --token $CI_JOB_TOKEN --branch $CI_COMMIT_REF_NAME --stack-type $STACK_TYPE --project-id $CI_PROJECT_ID
  retry:
    max: 2
    when:
      - runner_system_failure
      - stuck_or_timeout_failure

# This job gets triggered by the sprinkler.py script that get ran by the 'master_test_job' it ingests TEMPLATE_URL
# and TEMPLATE_PARAMETERS which are passed down by the sprinkler.py script. Using the variables runs dewdrop with
# the set environment variables
dewdrop_test_run:
  image: ${ARTIFACTORY_SERVER}/ecosystems-cloudsolutions-docker-dev/dewdrop:$DEWDROP_IMAGE_ID
  stage: droplets
  tags:
    - docker-executor
  variables:
    SSH_KEY: "$SSH_KEY"
    GOOGLE_PROJECT_ID: "$GOOGLE_PROJECT_ID"
    GOOGLE_PRIVATE_KEY_ID: "$GOOGLE_PRIVATE_KEY_ID"
    GOOGLE_CLIENT_EMAIL: "$GOOGLE_CLIENT_EMAIL"
    GOOGLE_CLIENT_ID: "$GOOGLE_CLIENT_ID"
    GOOGLE_PRIVATE_KEY: "$GOOGLE_PRIVATE_KEY"
    TEMPLATE_URL: "$TEMPLATE_URL"
    TEMPLATE_PARAMETERS: "$TEMPLATE_PARAMETERS"
    STACK_TYPE: "$STACK_TYPE"
    GITLAB_JOB_URL: "$CI_JOB_URL"
  only:
    variables:
      - $RUN_SCHEDULED_DEWDROP_TEST == "true"
  script:
    # the dewdrop image itself does not contain any test files, so ensure dewdrop
    # is run from the known location where test policies expect it to be
    # location: root of the cloud factory repository
    - if [ "$CLOUD_PROVIDER_ENVIRONMENT" == "aws_china" ]; then
    -   AWS_DEFAULT_REGION=$AWS_CHINA_DEFAULT_REGION
    -   AWS_ACCESS_KEY_ID=$AWS_CHINA_ACCESS_KEY_ID
    -   AWS_SECRET_ACCESS_KEY=$AWS_CHINA_SECRET_ACCESS_KEY
    - fi
    - python /dewdrop/dewdrop-docker.py

publish_to_github:
  image: ${ARTIFACTORY_SERVER}/dockerhub-remote/node:14
  stage: release
  only:
    - /(^publish-(v\d*[1-9]*\.)(\d).(\d).(\d))/
  script:
    # install jq
    - echo "deb http://archive.debian.org/debian stretch main" > /etc/apt/sources.list
    - apt-get update
    - apt-get install -y jq
    # Execute Release script to push source to github repo.
    - ./cloud-tools/release-tool/publish_github.sh "$ALLOWED_DIRS" "$ALLOWED_FILES"
  variables:
    ALLOWED_DIRS: "examples .github"
    ALLOWED_FILES: ".gitignore .gitattributes README.md"
    GITLAB_API_URL: "$GOOGLE_V2_URL"
    GITHUB_API_TOKEN: "$GOOGLE_V2_GITHUB_API_TOKEN"
    GITLAB_PRIVATE_TOKEN: "$GOOGLE_V2_GITLAB_API_TOKEN"

# validate README file(s) only contain links that respond with 200 OK
run_link_checker_release:
  image: ${ARTIFACTORY_SERVER}/dockerhub-remote/node:10
  stage: post-release-tests
  tags:
    - docker-executor
  only:
    # run only after release has been published
    - /(^publish-(\d+\.){1,2}(\d)-(\d+)?$)/
  except:
    refs:
      - schedules
      - triggers
      - pipelines
    variables:
      - $RELEASE_RUNTIME_INIT_TESTS == "true"
  script:
    - make link_check_release
  allow_failure: true

# verifies all examples use the latest AT Components versions
# temporarily allowing failure due to bug with DO 1.29.0
check_at_components_metadata:
  stage: smoke-tests
  image: ${ARTIFACTORY_SERVER}/dockerhub-remote/python:3
  except:
    refs:
      - schedules
      - triggers
      - pipelines
  script:
    - curl -sL https://deb.nodesource.com/setup_12.x | bash - && apt-get install -yq nodejs build-essential
    - apt-get install -y jq
    - pip3 install yq
    - if [[ ! -z ${RUNTIME_INIT_PACKAGE_URL} && ! $CI_COMMIT_BRANCH == "main" ]]; then ./cloud-tools/sync-at-components-metadata/sync_at_components_metadata.sh --config-directories examples/autoscale/bigip-configurations,examples/quickstart/bigip-configurations --template-directory examples --cloud gcp --runtime-init-package-url $RUNTIME_INIT_PACKAGE_URL; fi
    - if [[ -z $RUNTIME_INIT_PACKAGE_URL ]]; then ./cloud-tools/sync-at-components-metadata/sync_at_components_metadata.sh --config-directories examples/autoscale/bigip-configurations,examples/quickstart/bigip-configurations --template-directory examples --cloud gcp; fi
    - if git diff | grep 'diff --git'; then exit 1; else exit 0; fi
  tags:
    - cm-official-docker-executor
  allow_failure: true

# manually scheduled job to enable/disable daily scheduled test jobs
update_daily_test_schedules:
  image: ${ARTIFACTORY_SERVER}/dockerhub-remote/node:8
  stage: admin
  only:
    variables:
      - $UPDATE_SCHEDULES == "true"
  script:
    - apt-get update
    - apt-get install -y jq
    - ./cloud-tools/scheduler-tool/activate-schedule.sh
  variables:
    FILTER: "$FILTER"
    GIT_LAB_API_URL: "$GOOGLE_V2_URL"
    GIT_LAB_PRIVATE_TOKEN: "$GOOGLE_V2_GITLAB_API_TOKEN"
    STATE: "$STATE"
